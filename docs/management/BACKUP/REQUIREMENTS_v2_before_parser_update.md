# Project Requirements: Ori-Uma Race Aggregation Tool
## 1. Project Goal & Core Value

* **Project Goal:**
    掲示板（あにまん掲示板形式等）で行われる「オリウマレース」のGM（開催者）業務を支援し、集計負担と計算ミスをゼロにする。
    **【運用前提】** 本ツールは「GMが全てのダイスを管理・投稿・集計する」ことを前提とする。参加者が個別にダイスを振る運用は想定しない。
    複雑な脚質補正やダイス計算、テキスト整形作業を自動化することで、GMがExcel操作や検算に追われる時間をなくし、参加者との交流やロールプレイ（RP）に注力できる環境を提供する。

* **Core Values:**

    * **Copy & Paste Oriented (徹底したコピペ運用):**
        * 数値の直接手入力を原則として排除する（設定・登録時を除く）。
        * 掲示板のレス（テキスト）をそのままツールに貼り付けるだけで解析・計算が完結するUXを提供し、転記ミスや入力ミスが入り込む余地を根絶する。

    * **Strict Validation & Specific Feedback (厳格な整合性検証と具体的エラー通知):**
        * **【重要】** ツールは「曖昧なデータ」を推測して処理しない。入力されたダイスデータに対し、厳格な整合性チェック（ダイス個数とX値の一致、内訳の合計値とTotalの一致、行数の過不足など）を行う。
        * 不整合を検知した場合、ツール側での数値修正を求めるのではなく、「コピー範囲の選択ミス」や「掲示板への投稿ミス」がないかを確認し、正しいデータを再入力（貼り直し）するよう促す。これにより、データの正当性（改ざんがないこと）を担保する。
        * **【Error Message Tone】** エラーメッセージは、GMを萎縮させたり責めたりするような表現を避け、具体的かつ建設的な解決策を提示する（例：「3行目のダイス合計値が一致しません。コピー範囲が途切れていないか確認してください」）。

    * **Automated Complexity (複雑性の自動解決):**
        * 「捲り/溜め」のような「現在の行動が将来のターンに影響する」処理や、複雑な「着差判定（同着・ハナ・アタマ・クビ）」のロジックをシステム側で完全自動化する。
        * GMが記憶に頼って補正を行う運用を廃止し、ヒューマンエラーをシステム的に防ぐ。

    * **Progressive Disclosure (段階的開示):**
        * デフォルトでは「基本ルール」に則ったシンプルなUIのみを表示し、初心者GMが迷わず操作できるようにする。
        * 「ハウスルール設定」等のオプションを有効化したときのみ、高度な編集機能（脚質エディタ、手動補正ボタン等）や例外処理UIが開放される設計とする。

    * **Scalability & Flexibility (柔軟な規模対応):**
        * 1人（単走・動作確認）から、最大100人規模のバラエティレースまで、パフォーマンスを落とさずに処理できるスケーラビリティを確保する。
        * 将来的な掲示板の仕様変更や、他サイトでの開催に対応できるよう、解析ロジック（Parser）の拡張性を持たせる。
    * **Accessibility Scope (アクセシビリティ範囲):**
        * 初期リリースにおいては、スクリーンリーダー対応やキーボードナビゲーションの完全準拠は要件に含まない。これらはユーザーからのフィードバックに基づき、将来的なアップデートでの対応を検討する。

## 2. UI/UX Design (Wireframe)

### Scene 1: Setup & Entry
レースの基本設定と参加者登録を行う初期画面。
誤操作や確認漏れを防ぐため、初期値（デフォルト）を廃止し、すべての項目において明示的な選択・入力を必須とする設計とする。

```text
+-----------------------------------------------------------------------------+
| [Header] オリウマレース集計ツール v2.0            [⚙️ 設定(House Rule)]     |
+-----------------------------------------------------------------------------+
| ■ 0. レース設定 (Race Config)                                               |
|   中盤ダイスの回数: [ --- (v) ] (0～4回)                                    |
|   フルゲート人数　: [     ] 人  [ 入力欄生成(Update) ]                      |
|   ※ 1～100人まで設定可能です。                                              |
+-----------------------------------------------------------------------------+
| ■ 1. 出走者登録 (Entry List)                                                |
|   [ 🗑️ Reset ]                                         [ エントリー確定 > ] |
|                                                                             |
|   #  | 名前 (Text)      | 脚質 (Select) | 固有タイプ      | 発動位置      |
|  ----+------------------+---------------+-----------------+---------------|
|    1 | [              ] | [--- (v)    ] | [--- (v)      ] | [--- (v)    ] |
|    2 | [              ] | [--- (v)    ] | [--- (v)      ] | [--- (v)    ] |
|   ...                                                                       |
|   (指定した人数分の行を表示。名前が空欄の行は無視される)                    |
|                                                                             |
| [ Notification Area (Always Visible) ] ------------------------------------ |
| | ℹ️ レース設定を入力し、出走者を登録してください。                       |
| |                                                                         |
| +-------------------------------------------------------------------------+ |
+-----------------------------------------------------------------------------+
```

#### Component Behavior & Logic (仕様詳細)

1.  **初期状態とデフォルト値 (Initialization)**
    * **プルダウン初期値:** すべて `---` (未選択/null扱い) とする。
    * **テキスト入力初期値:** すべて空欄 (null/empty string) とする。
    * **中盤ダイス回数:** 未選択状態で開始。
    * **フルゲート人数:** 空欄で開始。
    * **通知エリア:** 初期メッセージ「ℹ️ レース設定を入力し、出走者を登録してください。」を表示。

2.  **レース設定 (Race Config)**
    * **フルゲート人数:**
        * ``1`` 以上の整数のみ入力許可。``0`` または負の値、非数値が入力された場合、直ちにエラー表示（または入力不可制御）を行い、「入力欄生成」ボタンを無効化する。
        * 画面上に「※ 1～100人まで設定可能です。」の注釈を表示する。
    * **中盤ダイスの回数と発動位置プルダウンの連動:**
        * **0回:** 選択肢から「中盤」に関連する項目を削除（``[---, 序盤, 終盤]``）。
        * **1回:** 表記を単に「中盤」とする（``[---, 序盤, 中盤, 終盤]``）。
        * **2回以上:** 「中盤1, 中盤2...」とナンバリングする（``[---, 序盤, 中盤1, 中盤2, 終盤]``）。
        * **共通データ適用:** レース設定で中盤フェーズが複数回設定された場合、すべてのフェーズにおいて共通の「中盤ダイス定義」を使用する。「中盤1用」「中盤2用」といった個別の脚質データ定義は行わず、常に単一の「中盤」パラメータを参照する。
        * **ペースフェーズの除外:** 「ペースフェーズ」は固有スキルの発動対象外であるため、プルダウンおよび複合固有（チェックボックス）の選択肢には表示しない。

3.  **通知エリア (Notification Area)**
    * 出走者リスト直下に常時表示する。
    * エラーや警告がない場合、操作を促すデフォルトメッセージを表示する。
    * 検証エラー発生時、エリアを下方向に自動拡張し、全てのエラーメッセージを箇条書きで表示する。

4.  **途中修正とデータ保持 (Modification & Persistence)**
    * **修正の許容:** レース進行中（Scene 2以降）であっても、Scene 1に戻りレース設定やエントリー内容（名前、脚質、固有タイプ等）を修正することを可能とする。
        * **中盤回数変更時の挙動 (Mid-Phase Adjustment):**
        * **データ保持 (Soft Delete):** 設定回数を減らした場合（例: 2回→1回）、非表示となるフェーズ（中盤2）の入力データ（ダイステキスト、算出スコア）は**削除せずメモリ上に保持し続ける**。
        * **計算除外:** ただし、現在の合計スコア計算においては、**「現在設定されているフェーズ」のみを合算対象**とし、設定範囲外となったフェーズのスコアは一時的に除外する。
        * **自動復元 (Restoration):** 回数を再度増やした場合（例: 1回→2回）、保持されていたデータが自動的に再表示され、合計スコア計算にも即座に復帰する。
        * **仕切り直し (Re-roll):** 復元されたデータを使用せずやり直したい場合は、該当フェーズ（Scene 3）にて新しいダイス結果を上書き貼り付けすることで更新可能とする。
        * **【NEW】固有発動位置の整合性強制 (Consistency Enforcement):**
            * 中盤回数の減少により、現在設定されている「固有発動位置」が存在しなくなる場合（例: `中盤2`指定で、回数を`1回 = 中盤1まで`に変更）、その出走者の発動位置選択を **即座に `---` (未選択/null)** に強制リセットする。
            * これにより「必須項目未入力」の状態を作り出し、エントリー確定をブロックして、GMに正しい再設定を促す。
    * **名前の修正:** 既存のスコアデータは新しい名前に自動的に紐付けられ、即座に画面表示に反映される（ダイス振り直しの必要なし）。
    * **設定（脚質/固有）の修正とデータ維持 (Retention & Recalculation):**
        * **原則維持:** エントリー情報を修正しても、**未来のフェーズ（Scene 3）に入力済みのテキストデータは削除せず維持する**。
        * **即時再計算:** 修正確定直後、維持されたテキストデータを新しい設定（脚質固定値、補正ロジック等）に基づいて再解析・再計算する。
        * **不整合の解決 (Conflict Resolution):**
            * 設定変更により、入力済みのダイス式が新しい設定と一致しなくなった場合（例: 脚質変更でダイス種別が変わった、固有タイプ変更でダイスが変わった等）、Scene 3のバリデーション機能が**「不整合がある行のみ」**を特定して警告を出す。
            * GMは、**誤りのあった箇所のダイス結果のみ**を掲示板等で振り直し、ツール上の入力テキストを部分的に差し替えることで対応する。
            * **影響のないデータの保護:** 変更の影響を受けない他のダイス（例: 脚質のみ変更時の固有ダイス、ペースダイス結果そのもの等）は、修正する必要なくそのまま有効として扱われる。

#### Error Handling & Validation (エラー検出と対応)

「エントリー確定」ボタン押下時、または入力状態の変化に応じて検証を行う。
エラーがある場合、**「エントリー確定」ボタンを押下不可（Disabled）とし、次画面への遷移を確実にブロックする**。通知エリアには以下のメッセージを表示する。

* **⛔ Critical Errors (進行不可):**
    * **設定未入力:**
        * 「中盤ダイス回数が選択されていません」
        * 「フルゲート人数を設定してください」
    * **有効なエントリーなし:** 「参加者が登録されていません。名前を入力してください。」
    * **必須項目の欠落:** 名前が入力されている行において、``---`` (未選択) のままの項目がある場合。
        * 表示形式: ``・[行番号] (名前) の (項目名) が未入力です``
        * 例: ``・3番 タンクタンクタンク の 脚質 が未入力です``
    * **名前の重複:** ``・名前 'XXX' が重複しています``
    * **使用禁止文字の検出:**
        * 名前入力欄において、以下の文字が含まれている場合、エラーを表示する。
        * **禁止文字:** `+` (プラス), `=` (イコール), 改行コード
        * **許容文字:** 半角スペース、`dice` という単語、アルファベット（欧字名対応のため許可）。
        * メッセージ: `・名前に計算記号(+, =)は使用できません`
    * **固有発動位置の不整合 (Inconsistent Phase):**
        * 条件: 中盤回数の減少等により、「存在しないフェーズ位置（例: 現在は設定がない中盤2など）」が固有スキル発動位置に設定されたままの出走者がいる場合。
        * **この状態が解消されるまで、エントリー確定は許可されない。**
        * メッセージ: ``・変更後の中盤回数にない位置が固有発動位置に指定されている出走者がいます（例: ウマ娘A）。設定を見直してください``

* **⚠️ Warnings (確認ダイアログ表示後に進行可):**
    * (現在、Warningレベルの項目は定義されていない)

### Modal: House Rule Configuration
ヘッダーの「⚙️ 設定」ボタンから呼び出されるモーダルウィンドウ。
基本ルールを拡張・変更するための高度な設定を行う。

```text
+-----------------------------------------------------------------------------+
| ⚙️ 設定 (House Rule & Configuration)                                     [x]|
+-----------------------------------------------------------------------------+
| 【基本オプション】(Basic Options)                                           |
|  [ ] 汎用補正(Modifier)ボタンを表示                                         |
|  [ ] 特殊戦法(ステータス変化: 捲り/溜め)を使用                              |
|  [ ] 複合固有スキル(発動位置複数選択)を許可                                 |
|                                                                             |
| 【脚質・ダイステーブル設定】(Strategy Editor)                               |
|  +-----------------------------------------------------------------------+  |
|  | 名前     | 序盤  | 中盤  | 終盤  | 操作                             |  |
|  |----------+-------+-------+-------+----------------------------------|  |
|  | 大逃げ   | 3d8   | 3d5   | -1d27 | [編集]                           |  |
|  | (Custom) | ...   | ...   | ...   | [編集] [削除]                    |  |
|  | 逃げ     | 3d6   | 3d5   | 1d7   | [編集] [↓ここに追加]             |  |
|  +-----------------------------------------------------------------------+  |
|                                                                             |
| 【設定プリセット管理】(Preset Management)                                   |
|  設定名: [ My House Rule A      ]                                           |
|                                                                             |
|  [ 💾 ブラウザに保存 ]    [ 📂 ブラウザから読込 ]                           |
|  ------------------------------------------------------------               |
|  [ 📥 ファイルから読込(.json) ]   [ 📤 ファイルへ保存(.json) ]              |
|                                                                             |
| [ Notification Area ] ----------------------------------------------------- |
| | ℹ️ 設定を変更後は必ず保存してください。                                 |
| +-------------------------------------------------------------------------+ |
+-----------------------------------------------------------------------------+
```

#### Component Behavior & Logic (仕様詳細)

1.  **基本オプション (Basic Options)**
    * チェックボックスのON/OFFにより、メイン画面（Scene 1, Scene 3）のUI要素の表示/非表示を即座に切り替える。
    * **汎用補正:** Scene 3 の各行に `[✎ 補正]` ボタンを追加。
    * **特殊戦法:** * 内部計算ロジックに「予約効果(Future Queue)」処理を有効化。
        * **パラメータ設定:** チェックON時、直下に「効果値 (Effect Value)」入力欄を表示する（デフォルト: `15`）。
    * **複合固有スキル:**
        * Scene 1 の固有タイプ選択肢に「持続型」を追加。
        * 「持続型」選択時のみ、発動位置指定UIが「チェックボックス（複数選択可）」に変化する。
        * **制約:** 原則として「連続する2つのフェーズ（例: 序盤・中盤）」を選択する。非連続のフェーズが選択された場合はクリティカルエラーとし、エントリー確定をブロックする。

2.  **脚質・ダイステーブル設定 (Strategy Editor)**
    * **編集 (Edit):** サブモーダルを展開し、各フェーズの「ダイス式」「固定値」「ペース補正マトリクス」を変更可能にする。
    * **ここに追加 (Insert):** 選択した行の「直後（真下）」に新規カスタム脚質行を追加する。
        * *Constraint:* デフォルト脚質（大逃げ、逃げ、先行、差し、追込）同士の順序入れ替えは不可。カスタム脚質は常にデフォルト脚質の間のどこかに挿入される形で管理する。
    * **削除 (Delete):**
        * カスタム脚質のみ削除可能。デフォルト脚質は削除不可。
        * **使用状況チェックと挙動分岐:** 削除しようとする脚質が、現在エントリー中の出走者に設定されている場合、レース進行度（Scene 3での序盤ダイス入力有無）に応じて以下の処理を行う。
        * **Case A: 序盤ダイス入力前 (Pre-Race):**
            * 即座に削除を実行する。
            * 同時に、その脚質を設定していた出走者の脚質選択を **``---`` (未選択)** に強制リセットする。
        * **Case B: 序盤ダイス入力済み (Mid-Race):**
            * **2段階確認 (Double Confirmation):**
                1.  **1st Warning:** 「この脚質は現在使用されています。削除すると、該当する出走者の設定がリセットされます」と警告を表示する。
                2.  **Final Confirm:** ユーザーが承認した場合、最終確認ダイアログを表示し、実行された場合のみ削除を行う。
            * 削除実行後、その脚質を設定していた出走者の脚質選択を **``---`` (未選択)** に強制リセットする。
        * **事後処理 (Validation):**
            * リセットにより未選択状態となった出走者は、既存のエラーチェック機能（Scene 1の「必須項目の欠落」またはScene 3のバリデーション）によって自動的に検知される。
            * GMはエラー通知に従い、既存の脚質から代替となるものを再選択することで整合性を回復させる。
    * **並び替え (Reorder):**
        * **機能なし:** ドラッグ＆ドロップや「上へ/下へ」移動ボタン等の並び替え機能は提供しない。
        * **順序修正:** 作成したカスタム脚質の順序を変更したい場合は、一度その脚質を **「削除」** し、目的の位置（挿入したい場所の直上の脚質）を選択して再度 **「追加」** を行う運用とする。

3.  **設定プリセット管理 (Preset Management)**
    * **ブラウザ保存/読込:** `LocalStorage` 内に、名前付きで複数の設定セットを保存できる。
    * **ファイル入出力:** アプリケーション外での共有やバックアップのため、JSONファイルとしてダウンロード/アップロードを行う。

#### Error Handling & Validation (エラー検出と対応)

* **⛔ Critical Errors (保存・適用不可):**
    * **脚質名の重複:** 「脚質名 'XXX' は既に使用されています。別の名前を指定してください。」
    * **不正なダイス形式:** ダイス入力欄（編集サブモーダル内）にて、`XdY` (例: `3d6`) 以外の形式が入力された場合、「ダイス式は '3d6' の形式で入力してください」とエラー表示。
    * **設定名の未入力:** 保存時に設定名が空欄の場合、「設定名を入力してください。」

* **⚠️ Import Validation (インポート時の検証):**
    * **JSONスキーマ不整合:** アップロードされたJSONファイルが期待する構造（`zod`スキーマ等）と一致しない場合、「ファイル形式が正しくありません。オリウマツール用の設定ファイルを選択してください」と表示し、読み込みを拒否する。

* **ℹ️ Confirmations (確認):**
    * **初期化/上書き警告:** 現在の設定が未保存の状態で「読込」を行おうとした場合、「現在の変更内容は失われます。読み込みますか？」とダイアログを表示する。

### Scene 2: Gate Lottery (枠順抽選)
出走者の枠順（Gate Number）を決定するフェーズ。
ここで確定した枠順（①, ②, ...）が、これ以降のレース進行における表示順の基準となる。

```text
+-----------------------------------------------------------------------------+
| [ < 内容修正へ(Back) ]   現在フェーズ: 【 枠順抽選 】                       |
+-----------------------------------------------------------------------------+
| [1] エントリー内容確認 (Confirm Entry)                                      |
|  以下のリストを掲示板に投稿し、参加者に登録内容の確認を促します。           |
|  -------------------------------------------------------------------------  |
|  1. ウマ娘A (逃げ / 安定 / ---)                                             |
|  2. ウマ娘B (先行 / ギャンブル / 終盤)                                      |
|  ...                                                                        |
|  -------------------------------------------------------------------------  |
| [ 📋 確認用リストをコピー ]                                                 |
+-----------------------------------------------------------------------------+
| [2] 枠順抽選ダイス出力 (Output Dice)                                        |
|  確認完了後、枠順を決めるためのダイスを出力します。                         |
|  -------------------------------------------------------------------------  |
|  1. ウマ娘A  dice1d100=                                                     |
|  2. ウマ娘B  dice1d100=                                                     |
|  ...                                                                        |
|  -------------------------------------------------------------------------  |
| [ 📋 ダイスリストをコピー ]                                                 |
+-----------------------------------------------------------------------------+
| [3] 結果取り込み (Paste Area)                                               |
|  -------------------------------------------------------------------------  |
|  [ ここにダイス結果レスを丸ごと貼り付けてください...                      ] |
|  [                                                                        ] |
|  -------------------------------------------------------------------------  |
|  [ 解析実行 ]                                                               |
+-----------------------------------------------------------------------------+
| [4] 枠順確定リスト (Result List)                                            |
|  -------------------------------------------------------------------------  |
|  ① ウマ娘C (出目: 15)                                                       |
|  ② ウマ娘A (出目: 45)                                                       |
|  ③ ウマ娘B (出目: 45) ... 同値時: エントリー順優先                          |
|  ...                                                                        |
|  -------------------------------------------------------------------------  |
| [ 📋 確定リストをコピー ]                  [ 枠順を確定してレース開始 > ]   |
|                                                                             |
| [ Notification Area ] ----------------------------------------------------- |
| | ℹ️ ダイス結果を貼り付けて「解析実行」を押してください。                 |
| +-------------------------------------------------------------------------+ |
+-----------------------------------------------------------------------------+
```

#### Component Behavior & Logic (仕様詳細)

1.  **枠順決定ロジック (Gate Determination Logic)**
    * **使用ダイス:** `1d100` (全出走者共通)
    * **ソート順:** ダイス出目の **昇順（小さい順）** で1枠から割り振る。
    * **同値判定 (Tie-Breaker):** 出目が同じ場合、**元のエントリー順（Scene 1での登録順）が早い者** を若い枠番（小さい数字）とする。
        * *Logic:* `ORDER BY dice_value ASC, entry_index ASC`

2.  **コピー用テキスト生成 (Text Generation)**
    * **確認用リスト:**
        * `[エントリー番号]. [名前] ([脚質] / [固有タイプ] / [発動位置])` の形式。
        * **用語統一:** 内部キー（English）ではなく、日本語表記を使用する（例: `逃げ`, `ギャンブル`, `中盤1`）。
    * **ダイスリスト:**
        * `[名前]　dice1d100=` の形式。
        * **区切り文字:** 名前とダイス式の間は **全角スペース (U+3000)** (`　`) を使用する。
        * ※掲示板システムがダイス結果を正しく付与できるよう、末尾に余計な文字を含めない。

3.  **解析と状態保持 (Parsing & State)**
    * **Back(戻る)挙動:** Scene 1 に戻る際、現在の状態（ダイス結果など）は保持される。「エントリー内容の修正」を行って再度Scene 2に来た場合、エントリーリストの差分に応じてダイス結果の再解析またはリセットを促す。

#### Error Handling & Validation (エラー検出と対応)

「解析実行」ボタン押下時、または「レース開始」遷移時に検証を行う。

* **⛔ Critical Errors (解析失敗/進行不可):**
    * **データ不足:** 貼り付けられたテキスト内に、エントリー人数分のダイス結果が見つからない場合。
        * メッセージ: `・ダイス結果が不足しています（登録: 18人 / 検出: 17人）。コピー漏れがないか確認してください`
    * **合計値不一致:** `dice1d100=... (Total)` の形式において、内訳と合計が一致しない場合（手書き修正の可能性）。
        * メッセージ: `・(名前) のダイス合計値が不正です。レスをそのまま貼り付けてください`
    * **名前の不一致:** 検出されたダイス行の名前が、登録されたエントリー名のいずれとも一致しない場合。
        * メッセージ: `・登録名と一致しないデータが含まれています: "(検出された名前)"`

* **⚠️ Warnings (確認ダイアログまたは強調表示):**
    * **未検出の出走者:**
        * 特定の出走者のダイスが見つからない場合、その出走者名を具体的にリストアップする。
        * `・以下の出走者のダイスが見つかりません: ウマ娘A, ウマ娘B`

### Scene 3: Progression (Main Loop)
レースの進行を行うメイン画面。
「序盤」→「ペース」→「中盤(設定回数分)」→「終盤」の順にフェーズが遷移する。

```text
+-----------------------------------------------------------------------------+
| [ < 内容修正へ(Back) ]   現在フェーズ: 【 序盤 】                           |
|                   (Flow: 序盤 > ペース > 中盤1 > ... > 終盤)                |
+-----------------------------------------------------------------------------+
| [1] 投稿用ダイス出力 (Output Dice)                                          |
|  現在のフェーズに必要なダイスを表示。常に【枠順 (Gate Order)】でソート。    |
|  -------------------------------------------------------------------------  |
|  【序盤ダイス】                                                             |
|  ①大逃げウマ娘  30+dice3d8=                                                |
|  ②先行ウマ娘    10+dice3d5=                                                |
|  ③追込ウマ娘    0+dice1d9=                                                 |
|                                                                             |
|  【序盤固有ダイス】                                                         |
|  ①大逃げウマ娘  dice1d20=                                                  |
|  -------------------------------------------------------------------------  |
| [ 📋 クリップボードにコピー ]                                               |
+-----------------------------------------------------------------------------+
| [2] 結果取り込み (Paste Area)                                               |
|  -------------------------------------------------------------------------  |
|  [ ここに掲示板のレスを丸ごと貼り付けてください...                        ] |
|  [ ※ダイス結果行を自動解析します                                          ] |
|  [ ※30人を超える場合、このエリアは仮想スクロールで表示されます            ] |
|  -------------------------------------------------------------------------  |
|  [ 解析実行 ]                                                               |
+-----------------------------------------------------------------------------+
| [3] 計算結果 & 操作 (Result & Dashboard)                                    |
|  ※ここでは「現在スコアの降順（中間順位）」でソートして表示される。          |
|                                                                             |
|  (A) 投稿用・中間順位リスト (Copy Target)                                   |
|  +-----------------------------------------------------------------------+  |
|  | ② 先行ウマ娘 (45)                                                     |  |
|  | ① 大逃げウマ娘 (40)                                                   |  |
|  | ③ 追込ウマ娘 (20)                                                     |  |
|  | ...                                                                   |  |
|  +-----------------------------------------------------------------------+  |
|  [ 📋 中間順位のみコピー ] (枠番、名前、現在値のみコピーされる)             |
|                                                                             |
|  (B) 実況補助・ハウスルール操作パネル (GM Dashboard)                        |
|  +-----------------------------------------------------------------------+  |
|  | 1位 ② 先行ウマ娘: [ ---  ]             [戦法: 捲り] [✎ 補正]         |  |
|  | 2位 ① 大逃げウマ娘: [ 1 1/4バ身 ]      [戦法: --- ] [✎ 補正]         |  |
|  | 3位 ③ 追込ウマ娘: [ 大差 (20バ身) ]    [戦法: --- ] [✎ 補正]         |  |
|  +-----------------------------------------------------------------------+  |
|   ※(B)の情報はコピーに含まれない。実況RPの参考として使用する。             |
+-----------------------------------------------------------------------------+
| [ 次のフェーズへ > ]                                                        |
+-----------------------------------------------------------------------------+
```

#### Component Behavior & Logic (仕様詳細)

1.  **フェーズ進行と計算ロジック (Phase Progression & Logic)**
    * **基本フロー:** `序盤` → `ペース` → `[可変中盤フェーズ]` → `終盤` の順に進行する。
    * **中盤構成のバリエーション (Mid-Phase Config):**
        * **0回:** `序盤` → `ペース` → `終盤`
        * **1回:** `序盤` → `ペース` → `中盤` → `終盤`
        * **2回以上:** `序盤` → `ペース` → `中盤1` → `中盤2`... → `終盤`
    * **ペースフェーズ (Pace Phase):**
        * 序盤フェーズの直後に必ず挿入される。
        * **処理主体と頻度:**
            * ペース決定ダイス（`1d9`）は、**GMがレース全体に対して「1回のみ」** 振る。
        * **出力:** `dice1d9=` に加え、現在の脚質設定に基づいた影響値テンプレートを動的に生成して出力する。
            * *Logic:* 各出目（1, 2-3, ... 9）に対し、設定されている脚質ごとの補正値を走査し、変動がある（0でない）脚質のみを列挙してテキスト化する。
            * *Format Example:*
                ```text
                dice1d9=
                1,ドスロー　大逃げに+12、逃げに+10...
                2.3,スロー　大逃げ・逃げ...に+5
                ...
                ```
            * *Custom Strategy:* ハウスルールで追加されたカスタム脚質も、リスト順に従ってテンプレートに含める。
        * **解析と表示:**
            * GMが投稿したレスを解析し、決定した「ペース（例：ハイペース）」と「各脚質への補正値」を画面に表示する。
            * **PACE専用解析:** このフェーズでは「ダイスの行数チェック」や「名前の照合」は行わず、テキスト全体から `dice1d9` の結果のみを抽出する。
            * **重要:** この時点では、画面上の「現在の合計スコア」に対して**補正値の加算・減算を行わない**（序盤終了時点のスコアを維持して表示する）。
        * **計算反映とダイス出力への適用 (Application Logic):**
            * **タイミング:** 「次のフェーズへ」ボタンを押下し、ペースフェーズの「直後にあるフェーズ」へ遷移する瞬間**に行う。
            * *Case 0回:* `終盤` 開始時に適用。
            * *Case 1回:* `中盤` 開始時に適用。
            * *Case 2回以上:* `中盤1` 開始時に適用。
            * **処理:** 確定したペース補正値（例: -7）を、現在の累積スコア（例: 59）に**直ちに加算（合算）する**。
            * **結果:** 次フェーズの画面表示および「投稿用ダイス出力」においては、この計算済みの値（例: 52）を「基礎値」として使用する。

2.  **投稿用ダイス出力 (Output Dice Formatting)**
    * **重要: ダイス形式 (Dice Format Rules):**
        * 掲示板システムの仕様に準拠するため、以下の順序を厳守する。
        * **通常ダイス (Phase Dice):** ``[基礎値] + [補正値] + dice[XdY] =``
        * **固有ダイス (Unique Skill Dice):** ``[固有固定値] + dice[XdY] =``
            * *Example (安定型):* ``5+dice1d10=``
            * *Example (ギャンブル型):* ``dice1d20=``
            * *Example (持続型):* ``dice1d10=``
    * **値の構成ルール (Value Composition):**
        * **[基礎値] (Base Value):** フェーズに応じて以下のいずれかを使用する。
            * **序盤 (First Phase):**
                * **「脚質ごとの初期固定値」** を出力する。
                * *User Example (大逃げ):* ``30+dice3d8=``
            * **中盤以降 (Subsequent Phases):**
                * **「前フェーズ終了時点の累積スコア（現在値）」** を出力する。
                * **ペース補正の反映:** ペースフェーズ直後のフェーズでは、ペース補正値をこの累積スコアに**合算（計算済み）**した状態で出力する。
                * *User Example:* 序盤終了時 ``59``、ペース補正 ``-7`` の場合、中盤ダイス式は ``52+dice3d5=`` となる（``59-7`` とは表記しない）。
        * **[補正値] (Modifier):**
            * ここには「ハウスルール設定による毎ターン加算」や「汎用補正（ダイス前確定分）」がある場合のみ記載する。
            * **除外対象:**
                * **ペース補正:** [基礎値]に含まれるため除外。
                * **特殊戦法（捲り/溜め）:** 事後適用（ダイス結果取り込み後に適用）のため除外。
                * **固有固定値:** 固有ダイス式の一部として扱うため、通常ダイス側からは除外。
    * **セクション分離 (Formatting):**
        * 通常ダイスと固有ダイスを空行で分け、それぞれにヘッダー（``【〇〇ダイス】``、``【〇〇固有ダイス】``）を付与する。
        * ※固有対象者がいない場合、固有ダイスセクションは表示しない。

3.  **計算結果とコピー範囲 (Result & Copy Scope)**
    * **表示ソート:** **現在スコアの降順 (Ranking)**。
    * **コピー機能の分離:**
        * **[1] ダイス出力:** ヘッダー、ペーステンプレートを含むテキスト全体。
        * **[3] 中間結果:** `(A) 投稿用リスト` の領域にある「枠番・名前・スコア」のみ。実況補助や操作UIは除外する。

4.  **実況補助 (Commentary Aid) ロジック**
    * **対象:** その行のウマ娘と、一つ上の順位のウマ娘との「点数差」を表示する。
    * **判定基準:**
        * **0～1点差 (Scene 3 特有):** 道中のため `並ぶ` と表示する。
        * **2点差以上 (全シーン共通):** `差分 / 4` を計算し、**分数または帯分数**で表示する（1点=1/4バ身）。
            * *Note:* 「大差」等の特殊表記置換は行わず、数値通り（例: `15`バ身差）に表示する。このルールはScene 4（ゴール）とも共通である。

5.  **特殊戦法操作 (Special Strategy Operation)**
    * **対象:** ハウスルールで「特殊戦法」が有効化されている場合のみ、Dashboardに ``[戦法: 捲り]`` 等のボタンが表示される。
    * **挙動 (Toggle & Undo):**
        * **タイミング:** ダイス結果を取り込み、スコアが表示された**後**に操作する。
        * **状態と操作:** ボタンはトグル式（ON/OFF切り替え）とする。
            * **[OFF状態 (未選択)]:**
                * クリックで **ON** に切り替わる。
                * 即座に現在のフェーズスコアに補正値を適用し、(A)の中間順位リストを再計算する。
                * 見た目: 押下状態（Active）または色付きで強調表示する。
            * **[ON状態 (適用中)]:**
                * クリックで **OFF** に戻る（取り消し）。
                * 適用していた補正値を解除し、スコアと順位を元に戻す。
                * 見た目: 通常状態に戻る。
        * **制約 (Usage Limit):**
            * 1レースにつき、1人の出走者あたり1回限り有効（ONにできるのは全フェーズを通じて1回のみ）。
            * **再利用:** 一度ONにしても、**そのフェーズ内にOFF（取り消し）にすれば「未使用」とみなされる**。
            * これにより、誤ってクリックした場合や、直前で戦術を変更したい場合でも、取り消して**後のフェーズで改めて使用することが可能**となる。
            * ※ただし、フェーズをまたいで確定（「次のフェーズへ」遷移）した後は、過去のフェーズに戻って変更しない限りロックされる。

6.  **ナビゲーションと履歴操作 (Navigation & History)**
    * **[ < 内容修正へ(Back) ] ボタン:**
        * **挙動:** 現在のフェーズ進行をキャンセルし、**「一つ前のフェーズ」の状態を完全に復元して戻る**（Undo動作）。
        * **完全な状態復元:**
            * 数値的なフェーズ履歴（ダイス結果・スコア）に加え、**ユーザーが手動で入力した情報も完全に復元する**。
            * 復元対象:
                * **ハウスルールオプション操作:** 特殊戦法（捲り/溜め）のON/OFF状態。
                * **汎用補正値:** 「補正」ボタンで入力された数値およびラベル。
        * **遷移ルール:**
            * 現在が `ペース` ～ `終盤` の場合: 直前のフェーズに戻る。
            * 現在が `序盤` の場合: Scene 2（枠順抽選）に戻る。
        * **目的:** 誤って「次のフェーズへ」を押してしまった場合や、前のフェーズの入力ミスに気づいた際の修正用。

#### Error Handling & Validation (エラー検出と対応)

* **⛔ Critical Errors (解析失敗/進行不可):**
    * **データ行数不一致 (Missing Rows):**
        * 貼り付けられたテキスト内の有効なダイス行数が、エントリー人数と一致しない場合（ペースフェーズを除く）。
        * **重要:** 参加者の欠席とはみなさず、**「GMによる投稿漏れやコピー範囲のミス」として扱い、進行をブロックする**。
        * メッセージ: `・データ行数が一致しません（登録: 18 / 検出: 17）。コピー範囲が途切れていないか確認してください`
    * **合計値不整合 / フォーマット不正:**
        * `diceXdY=... (Total)` の形式において、「(Total)」が欠落している、または内訳の合計と `(Total)` の値が一致しない場合。
        * メッセージ: `・(名前) のダイス形式または計算結果が不正です。レスを改変せず、行末の(合計)まで含めて貼り付けてください`
    * **名前の不一致:** 検出された名前が、登録されたエントリー名のいずれとも一致しない場合。
        * メッセージ: `・登録名と一致しないデータが含まれています: "(検出された名前)"`
    * **ペースダイス欠落:**
        * ペースフェーズにおいて、`1d9` の結果が見つからない場合。
        * メッセージ: `・ペースダイス(dice1d9)が見つかりません。コピー漏れがないか確認してください`
    * **ペースダイス重複:**
        * 複数の `dice1d9` が検出された場合（重複投稿など）。
        * メッセージ: `・複数のペースダイスが検出されました。内容を確認してください`

* **ℹ️ Phase Transition Check (遷移時チェック):**
    * **解析未実行:** ダイス出力後、結果の貼り付けと解析（スコア更新）を行わないまま「次のフェーズへ」を押した場合。
        * 挙動: 確認ダイアログを表示する。
        * メッセージ: `解析を実行していません（スコアが更新されていません）。次のフェーズに進みますか？`

### Scene 4 (Step 4-A): Judgment (判定割り込み)
レース終了時に「同点（0差）」または「1点差」のペア/グループが存在する場合に自動的に遷移する。
確定順位を出すために必要な追加ダイスを出力し、結果を取り込む画面。
※判定が必要ない（全順位が2点差以上で確定している）場合は、このステップをスキップして Step 4-B へ進む。

```text
+-----------------------------------------------------------------------------+
| [ < 戻る(確認) ]   現在フェーズ: 【 最終結果判定 】                         |
+-----------------------------------------------------------------------------+
| ⚠️ 写真判定(同点) または 着差判定(1点差) が必要です。                       |
|                                                                             |
| [1] 暫定順位リスト (Provisional Rank List)                                  |
|  現在のスコア順に並べた暫定リスト。GMが状況把握・報告に使用する。           |
|  -------------------------------------------------------------------------  |
|  1. ① ウマ娘A (85)                                                          |
|  2. ② ウマ娘B (84) ... Aと1点差 / Cと同点                                   |
|  2. ③ ウマ娘C (84) ... Aと1点差 / Bと同点                                   |
|  4. ④ ウマ娘D (83) ... B,Cと1点差                                           |
|  ...                                                                        |
|  -------------------------------------------------------------------------  |
| [ 📋 暫定リストをコピー ]                                                   |
+-----------------------------------------------------------------------------+
| [2] 判定用ダイス出力 (Output Judgment Dice)                                 |
|  必要な判定ダイスのみを自動抽出し、説明文と共に出力する。                   |
|  -------------------------------------------------------------------------  |
|  【写真判定】1d5で判定します。数値が大きい方が先着、同値は同着              |
|  ② ウマ娘B dice1d5=                                                         |
|  ③ ウマ娘C dice1d5=                                                         |
|                                                                             |
|  【着差判定】1d2で判定します。1. アタマ 2. クビ                             |
|  ① ウマ娘Aと② ウマ娘Bの着差判定 dice1d2=                                   |
|  ② ウマ娘Bと④ ウマ娘Dの着差判定 dice1d2=                                   |
|  ※(84点Gの代表として枠順が若いBを選出しています)                            |
|  -------------------------------------------------------------------------  |
| [ 📋 判定用ダイスをコピー ]                                                 |
+-----------------------------------------------------------------------------+
| [3] 判定結果取り込み (Paste Area)                                           |
|  -------------------------------------------------------------------------  |
|  [ ここに判定ダイスの結果レスを貼り付け...                                ] |
|  [                                                                        ] |
|  -------------------------------------------------------------------------  |
| [ 判定結果を反映して順位確定 > ] (Step 4-Bへ進む)                           |
+-----------------------------------------------------------------------------+
```

#### Component Behavior & Logic (仕様詳細)

1.  **判定対象の検出ロジック (Detection Logic)**
    * **Step 1: グループ化**
        * 全出走者を `スコア降順 > 枠順昇順` でソートする。
        * スコアが同じ出走者を「同点グループ」としてまとめる。
    * **Step 2: 写真判定の必要性チェック**
        * グループ人数が **2人以上** の場合、そのグループは「写真判定対象」となる。
    * **Step 3: 着差判定の必要性チェック**
        * 「スコア N のグループ」と「スコア N-1 のグループ」が隣接している場合、その境界は「着差判定対象」となる。

2.  **判定用ダイス出力 (Output Formatting)**
    * **写真判定セクション:**
        * ヘッダー: `【写真判定】1d5で判定します。数値が大きい方が先着、同値は同着`
        * 対象となる全グループの全メンバーに対し、`[名前] dice1d5=` を出力する。
        * **重要:** 複数の同点グループがある場合（例: 85点の集団と、70点の集団）、グループ間に空行を挿入して視覚的に分離する。
    * **着差判定セクション:**
        * ヘッダー: `【着差判定】1d2で判定します。1. アタマ 2. クビ`
        * **出力行:** 対象となるグループ間の境界ごとに1行出力する。連鎖している場合は複数行が出力される。
            * *Example:*
                `①ウマ娘A(100点)と②ウマ娘B(99点)の着差判定 dice1d2=`
                `②ウマ娘B(99点)と③ウマ娘C(98点)の着差判定 dice1d2=`
        * **代表者選出:** ダイス行の名前には、各グループ内で **最も枠順が若いウマ娘** を使用する。

3.  **暫定順位リスト表示**
    * 判定前のスコアに基づきリストを表示する。
    * 右側に「同点」「1点差」等の注釈を表示し、なぜ判定が必要なのかをGMに明示する。
    * コピペ用テキストには注釈を含めず、単純なリストとして出力する。

3.  **ナビゲーション (Navigation)**
    * **[ < 戻る(確認) ] ボタン:**
        * 押下すると **Scene 3（終盤フェーズ）** に戻る。
        * 入力済みの判定データや、フェーズ遷移前の状態は保持される。

#### Error Handling & Validation (エラー検出と対応)

* **⛔ Critical Errors (解析失敗/進行不可):**
    * **データ不足:** 出力された判定ダイスの行数に対し、貼り付けられた結果の行数が不足している場合。
        * メッセージ: `・判定結果が不足しています。対象者全員分のダイス結果を含めてください`
    * **名前の不一致:** 貼り付けられた判定ダイスの名義が、判定対象者のいずれとも一致しない場合。
        * メッセージ: `・判定対象ではない名前が含まれています: "(名前)"`
    * **ダイス種別の誤り:** 写真判定(`1d5`)の箇所に`1d2`が貼られている、あるいはその逆の場合。
        * メッセージ: `・ダイスの種類が正しくありません。写真判定は1d5、着差判定は1d2である必要があります`

* **ℹ️ Skip Check (スキップ判定):**
    * 判定対象者が存在しない（全順位が確定済）場合、この画面は表示されず、自動的に Step 4-B へ遷移する。

### Scene 4 (Step 4-B): Final Output (最終結果確定)
全ての判定処理が完了した後の最終リザルト画面。
GMはここで結果を確認し、テキストまたは画像をコピーして掲示板に投稿する。

```text
+-----------------------------------------------------------------------------+
| [ < 戻る(確認) ]         [ 🔄 最初から新しいレースを始める(Reset) ]         |
+-----------------------------------------------------------------------------+
| 🏆 最終結果確定 (Final Result)                                              |
|  -------------------------------------------------------------------------  |
|  着順 | 名前 (Left Align)    | 合計 | [判定] | 着差(to Prev)                |
|  ----+-----------------------+------+--------+------------------------------|
|    1 | 逃げ切りシスターズ    |   85 |   --   | --                           |
|    2 | 豪脚ステイヤー        |   84 |  (4)   | アタマ                       |
|    3 | 差し切りウマ娘        |   84 |  (2)   | ハナ                         |
|    4 | 粘り腰先行            |   83 |   --   | クビ                         |
|    5 | 大穴の追込            |   82 |   --   | アタマ                       |
|    6 | 普通のウマ娘          |   70 |   --   | 3                            |
|    7 | 不調なウマ娘          |   20 |   --   | 12 1/2                       |
|    8 | 仲良しコンビA         |   10 |  (5)   | 2 1/2                        |
|    8 | 仲良しコンビB         |   10 |  (5)   | 同着                         |
|   10 | 伝説の周回遅れ        |  -50 |   --   | 15                           |
|  -------------------------------------------------------------------------  |
| [ 📋 確定リスト(Text)をコピー ]  [ 🖼️ 掲示板風画像を保存(.png) ]            |
|                                                                             |
+-----------------------------------------------------------------------------+
```

#### Component Behavior & Logic (仕様詳細)

1.  **最終結果リストの表示 (Final List Display)**
    * **着順 (Rank):** 1位から順に表示。同着の場合は同じ数字を表示し、次の順位をスキップする（例: 1, 1, 3...）。
    * **[判定]列 (Judgment Info):**
        * **写真判定ダイス** の出目（`(5)`など）のみを表示する。着差判定ダイスの結果は、計算後の「着差表記」に反映されるため、この列には表示しない。
        * **同着時の表示:** 写真判定ダイスも同値で同着となった場合、対象者全員に同じ値を表示する。
        * GMが「なぜこの順位になったか」を確認できるようにする。
        * **重要:** この列はツール上の確認用であり、**クリップボードへのコピーや画像出力には含めない**。
    * **着差 (Margin) 表記:**
        * **1位:** `---` (ハイフン)
        * **0点差 (同点):**
            * 写真判定ダイスが異なる場合: 勝者＝`---`、敗者＝`ハナ`
            * 写真判定ダイスも同じ場合: 両者＝`同着`
        * **1点差:** 着差判定ダイスが `1`=アタマ、`2`=クビ。
        * **2点差以上:** `差分 / 4` を計算し、分数または帯分数で表示する（上限なし）。

2.  **出力機能 (Output Functions)**
    * **テキストコピー:**
        * 形式: `[着順] [名前] ([合計点]) [着差]`
        * シンプルなテキストリストとしてクリップボードにコピーする。
    * **画像保存 (Image Generation):**
        * **技術:** `html2canvas` を使用。
        * **レンダリング:** 画面外（Off-screen）に `width: 1200px` 固定の専用コンテナを作成して描画する。
        * **分割生成 (Split Output):**
            * **閾値:** 1枚の画像につき最大 **25人（25行）** までとする。
            * **挙動:** 出走者が26名以上の場合、自動的にファイルを分割して生成する（例: `result_1.png` [1-25位], `result_2.png` [26-50位]...）。
            * **ヘッダー付与:** 2枚目以降の画像にも、1枚目と同様のヘッダー行（着順・名前・着差）を付与し、単独で閲覧可能な状態にする。
        * **スタイル (Initial Implementation):**
            * 視認性を最優先した**シンプルな白背景のテーブルデザイン**とする。
            * フォントは標準の `sans-serif` (システムフォント) を使用する。
            * ※電光掲示板風のリッチデザインは、将来的なアップデートでの対応とする。
        * **内容:** `着順 | 名前 | 着差` の3カラム構成とし、合計点や判定ダイス情報は省く。

3.  **リセット機能 (Reset)**
    * **最初から始める:**
        * 確認ダイアログを表示後、全ての状態（エントリー、レース進行）を初期化し、Scene 1 に戻る。
        * ※ハウスルール設定（Config）は初期化せず保持する。

4.  **ナビゲーション (Navigation)**
    * **[ < 戻る(確認) ] ボタン:**
        * 押下すると **Scene 4-A（判定画面）** に戻る。判定がスキップされていた場合は **Scene 3（終盤フェーズ）** に戻る。
        * 確定済みの順位や判定データは保持される。

#### Error Handling & Validation (エラー検出と対応)

* **ℹ️ Confirmation (確認):**
    * **リセット確認:** 誤操作防止のため、「最初から始める」ボタン押下時は必ず確認ダイアログを表示する。
        * メッセージ: `現在のレース結果を破棄して、新しいレースを始めますか？`
    * **画像保存:**
        * ブラウザのポップアップブロック等が作動した場合、または `html2canvas` の生成エラー（メモリ不足等）が発生した場合。
        * メッセージ: `・画像を保存できませんでした（エラー: [詳細]）。テキストコピー機能を利用してください`

## 3. Functional Requirements

### A. Data & Logic (Basic Rules)
アプリケーションが準拠すべき基本ゲームロジックおよび定数データ。
ハウスルールが適用されない限り、以下の定義がデフォルトとして使用される。

#### 1. 枠順決定ロジック (Gate Determination)
* **Dice:** 各出走者が `1d100` を振る。
* **Sorting (優先順位):**
    1.  ダイス出目の **昇順（小さい順）**
    2.  出目が同じ場合、**エントリー順が早い（リストの上位）** 出走者を優先
    * *System Logic:* `ORDER BY dice_value ASC, entry_index ASC`
* **Assignment:** ソート後の順序に従い、上から順に 1枠, 2枠... と割り振る。
* **Note (Validation):** Scene 1 のバリデーションにより、名前の重複は排除されている前提とする。万が一、同名の出走者が検出された場合はクリティカルエラー（システム矛盾）として処理する。

#### 2. 基本脚質データ (Default Strategy Data)
ルールブック①～④に基づく、各脚質の固定値およびフェーズ別ダイス定義。

| 脚質名 | 固定値 (Fix) | 序盤ダイス | 中盤ダイス | 終盤ダイス | 特記事項 |
| :--- | :---: | :---: | :---: | :---: | :--- |
| **大逃げ** | 30 | 3d8 | 3d5 | -1d27 | 終盤は**減算**処理となる ※1 |
| **逃げ** | 15 | 3d6 | 3d5 | 1d7 | |
| **先行** | 10 | 3d5 | 3d5 | 4d5 | |
| **差し** | 5 | 1d12 | 1d15 | 1d33 | |
| **追込** | 0 | 1d9 | 1d15 | 1d46 | |

* **補足:** 中盤フェーズが複数回（中盤1, 中盤2...）設定されている場合、すべての当該フェーズで上記の「中盤ダイス」を使用する。
* **※1 大逃げの終盤ダイス仕様:**
    * **計算ロジック:** `1d27` の出目をそのまま「負の値」として扱う（例: 出目が `15` なら `-15`）。
    * **出力フォーマット:** `dice-1d27=` ではなく、`-dice1d27=` という形式で出力し、掲示板システム側で「マイナスのダイス」として解釈させる。

#### 3. ペース補正データ (Pace Modifier Data)
ルールブック⑤に基づく、ペースダイス `1d9` の出目に応じた脚質別補正値。
この補正値は、中盤以降のスコア計算時に固定値として加算（または減算）される。

* **適用ルール (Application Rule):**
    * **Single Roll:** `1d9` は1レースにつき1回のみ振られる。
    * **Global Effect:** 出目は全出走者共通として扱われ、個々の出走者が個別にペース判定を行うことはない。
    * **Timing (反映タイミング):**
        * ペースフェーズ直後のフェーズ（中盤、中盤1、または終盤）の **「ダイス出力テキスト生成前」** に適用する。
        * 補正値は累積スコア（現在値）にマージされ、プレイヤーが掲示板に投稿する時点では既に計算済みの状態とする。

| 出目 | ペース判定 | 大逃げ | 逃げ | 先行 | 差し | 追込 |
| :---: | :--- | :---: | :---: | :---: | :---: | :---: |
| **1** | ドスロー | +12 | +10 | +5 | ±0 | -5 |
| **2, 3** | スロー | +5 | +5 | +5 | ±0 | ±0 |
| **4, 5, 6** | ミドル | ±0 | ±0 | ±0 | ±0 | ±0 |
| **7, 8** | ハイ | ±0 | ±0 | ±0 | +5 | +5 |
| **9** | 超ハイ | -7 | -5 | ±0 | +5 | +10 |

#### 4. 固有スキル仕様 (Unique Skill Logic)
ルールブック⑥に基づく固有スキルの定義。
* **タイプ定義:**
    * **安定型:** `5 + 1d10`
        * *Note:* 固定値 `5` は固有ダイス式の一部として扱い、脚質固定値とは合算しない。
    * **ギャンブル型:** `1d20`
    * **持続型 (Persistent):** `1d10` (各発動フェーズごとに振る)
        * *Note:* ハウスルール（複合固有スキル）有効時のみ選択可能。
* **適用ルール:**
    * エントリー時に指定されたフェーズ（序盤/中盤(n)/終盤）においてのみ、ダイス出力およびスコア加算が行われる。
    * **除外ルール:** 「ペースフェーズ」においては、いかなる種類の固有スキルも発動しない。

#### 5. 順位判定・着差ロジック (Judgment & Margin Algorithm)
レース終了時のスコアに基づく最終順位および着差の計算手順。

1.  **Grouping (グループ化):**
    * 全出走者を **スコア降順 > 枠順昇順** でソートする。
    * スコアが同じ出走者を「同点グループ」としてまとめる。

2.  **Need for Judgment (判定要否チェック):**
    * **写真判定:** 同点グループの人数が **2人以上** の場合、そのグループ全員に `1d5` を振らせる。
    * **着差判定 (Margin Judgment):**
        * **境界判定:** 「スコアNのグループ」と「スコアN-1のグループ」（1点差）が隣接している場合、その**すべての境界**に対して `1d2` を振らせる。
        * **連鎖時の処理 (Chain Rule):**
            * 3グループ以上が連続して1点差の場合（例: A[100] > B[99] > C[98]）、`A vs B` および `B vs C` の両方の判定を行う。
            * 中間のグループ（B）は、上位（A）との判定では「敗者側」、下位（C）との判定では「勝者側」として関与することになるが、処理上は独立した2つのダイスとして扱う。
        * **Representative (代表者):**
            * 各判定ダイスの名義には、比較対象となる各グループ内で **最も枠順が若い（番号が小さい）ウマ娘** を自動選出する。

3.  **Final Calculation (最終確定ロジック):**
    * **0点差 (同点):**
        * 写真判定(`1d5`)の値が大きい方を上位とする（ハナ差）。
        * ダイス値も同じ場合、「同着(Dead Heat)」とし、順位も同じ数字（例: 1着, 1着）とする。
    * **1点差:**
        * 着差判定(`1d2`)が `1`=アタマ、`2`=クビ。
        * **順位変動なし (No Rank Change):**
            * このダイス結果は「着差表記」のみに使用される。
            * **写真判定とは異なり、このダイスの出目によって上位・下位が入れ替わることは絶対にない**（常にスコアが高い方が上位のままである）。
    * **2点差以上:**
        * `差分 / 4` を計算する（1点=1/4バ身）。
        * 表示は**分数または帯分数**とする（例: `1/2`, `1 1/4`, `25`）。
        * *Rule:* 「大差」等の特殊表記への置換は行わず、数値がどれだけ大きくなっても計算結果を表示する。

4.  **Scene 3 (道中) での例外表示:**
    * 道中の実況補助表示においては、**0～1点差は一律で「並ぶ」** と表示し、写真/着差判定ダイスは要求しない。2点差以上の計算式は共通とする。

#### 6. スコア計算モデル (Score Calculation Model)
* **累積加算方式 (Cumulative System):**
    * レースのスコア計算は、フェーズごとの独立評価ではなく、**「累積（積み上げ）」** 方式を採用する。
    * **計算式:** ``現在の合計スコア = Σ(有効な全フェーズのスコア)``
* **有効フェーズの定義 (Active Phases):**
    * 合計スコアに含まれるのは、Scene 1の「中盤ダイス回数」設定によって**現在有効化されているフェーズのみ**とする。
    * 設定変更により無効化（非表示）されたフェーズのスコアデータは、内部的に保持されるが、合計値には加算しない。
* **スコアの永続性:**
    * 序盤や中盤で獲得したスコア、および適用されたペナルティ（減点）は、そのフェーズ終了後もリセットされることはなく、最終結果まで持ち越される。

#### 7. 途中修正運用ルール (In-Race Correction Policy)
レース運営中にエントリー情報の誤りが発覚した場合のシステム挙動定義。

* **Principle (原則):**
    * **Recalculate over Reset:** ミスが発覚した時点で、レース全体を無効化（リセット）することなく、**誤りのあった最小単位のみを修正**して続行することを許容する。
    * **Minimal Fix & Full Restore:**
        * 入力済みのデータを破棄せず、**「データを維持したまま、正しい設定で再計算する」** ことを基本とする。
        * **手動データの保護:** 修正やUndo操作時において、ユーザーが手動で入力した**「ハウスルール（戦法操作）」や「汎用補正値」は決して消失させてはならず、必ず復元・維持される**。
* **Case 1: 名前の訂正 (Name Correction)**
    * 誤字脱字の修正や、エントリー名の変更。
    * **処理:** 内部ID（Index）ベースでデータを管理し、表示名のみを更新する。過去のダイス結果やスコアは全て有効なものとして維持される。
* **Case 2: 固有タイプ修正 (Unique Skill Correction)**
    * *Scenario:* 中盤1通過後に、固有タイプ登録ミス（例: `安定`→`ギャンブル`）が発覚し修正した。
    * **処理:**
        * 訂正対象は「固有ダイス（式が異なる部分）」のみとなる。
        * 同一フェーズ内の「通常ダイス（移動ダイス）」は影響を受けないため、そのまま維持される。
* **Case 3: 脚質設定修正 (Strategy Correction)**
    * *Scenario:* ペースフェーズ通過後に、脚質設定ミス（例: `逃げ`→`追込`）が発覚し修正した。
    * **処理:**
        * **固定値の再適用 (Fixed Value Update):**
            * 序盤フェーズの計算に使用された「脚質固定値」は、**修正後の脚質で定義されている値**（例: 逃げ`15` → 追込`0`）に即座に差し替えられ、全フェーズの累積スコアが再計算される。
        * **ダイス式 (Dice Formula):**
            * 基礎ダイス（XdY）が変更前の脚質と異なる場合は、その部分のみ振り直し・修正を行う。
            * 同じダイス式（例: 共に3d5）であれば、結果を維持してもよい。
        * **固有ダイス:** 脚質と独立している場合、結果は維持される。
        * **ペース補正:** 既に入力されているペースダイス（`1d9`）の結果は維持される。ツールは「維持された出目」と「修正後の脚質」に基づき、**自動的に正しい補正値（例: 追込としての補正）を再計算して適用する**。
    * **Exception (Strategy Deletion):**
        * もし修正によって「削除済みの脚質」や「未選択 `---`」状態になった場合、**正しい脚質が選択されるまでレース進行をブロックする（クリティカルエラー）**。「固定値を0として計算」などの推測処理は行わない。

### B. House Rule & Advanced Features (The "Expansion")
オプション設定により有効化される拡張機能群。
Progressive Disclosureの原則に基づき、デフォルトでは無効化（または非表示）されており、必要なGMのみが設定画面からこれらを有効化する。

#### 1. 脚質エディタ (Strategy Editor)
デフォルト脚質の調整および新規脚質の追加機能。

* **Edit (編集):**
    * 既存の5脚質のパラメータ（フェーズごとのダイス、固定値）を編集可能。
    * ペース補正マトリクス（各ペース出目に対する補正値）も編集可能。
    * **データ構造:** 編集・定義するパラメータはあくまで「序盤・中盤・終盤」の3フェーズ分とする。「中盤1」「中盤2」といった個別定義欄は作成しない（中盤設定時は一律で適用されるため）。
* **Insert (挿入):**
    * 既存の脚質を選択し、「その直後（真下）」に新規カスタム脚質を挿入できる。
    * **Default Values (初期値):** ユーザーの入力負荷を軽減するため、**選択した（直前の）脚質の全パラメータ（ダイス式・固定値・ペース補正）をコピー**した状態で初期化する。
    * *Constraint:* デフォルト脚質同士の相対的な順序（大逃げ < 逃げ < ... < 追込）を入れ替えることはできない。カスタム脚質はこの順序の中に割り込む形で定義される。
* **Reordering Constraint (並び替え制約):**
    * 作成済みの脚質リストに対する並び替え機能は実装しない。
    * ユーザーが順序を間違えた場合は、「削除して再作成」することで対応する仕様とする。
* **Validation:**
    * **脚質名の重複:** 禁止。エラーとして保存をブロックする。
    * **ダイス式:** `XdY` 形式（例: `3d6`）以外の入力を拒否する。

#### 2. オプションフラグ (Option Flags)
設定画面でチェックを入れることで開放されるUI/機能。

* **[v] 汎用補正 (Generic Modifier):**
    * Scene 3 の結果リスト各行に `[✎ 補正]` ボタンを追加する。
    * ボタン押下時、**補正入力用モーダル** を表示する。
    * **入力UI構成:**
        * **数値入力:** 加算・減算したい値を入力（例: `+5`, `-3`）。入力範囲の制限は設けないが、将来的な制限を考慮した設計とする。
        * **理由ラベル（必須）:** 補正の理由テキスト（例: "妨害", "ファンブル"）。必須項目とし、空欄での登録は不可とする。
        * **取り消し:** 入力済みの補正を削除する場合、同モーダル内からクリア操作を行う。
    * 任意のタイミングで数値の加算/減算を行い、その理由（ラベル）を記録できる機能を開放する。
    * **Behavior (挙動):**
        * 入力された数値は「現在の累積スコア」に対して即座に加算（または減算）される。
        * **永続性の定義:** この補正は「永続的なステータス上昇（以降の全ダイス判定に自動で+Nされ続けるバフ）」としては扱わない。しかし、**スコア計算自体が累積方式であるため、ここで増減させたスコア結果は、次フェーズ以降の合計値にも引き継がれる**（実質的な影響は持続する）。
    * **Constraints (制約):**
        * **Usage Limit:** レース全体での総使用回数に制限はないが、**1人の出走者につき、1フェーズあたり1回のみ**入力可能とする。
        * **Aggregation:** 同一フェーズ内で複数の補正要因（例：ギミックAで+5、妨害Bで-3）が発生した場合、GMはそれらを合算した値（この場合は`+2`）を算出し、1回で入力する。
* **[v] 複合固有スキル (Complex Unique Skill):**
    * Scene 1 (Entry) の固有タイプ選択肢に「持続型」を追加する。
    * 「持続型」選択時のみ、発動位置指定UIが「チェックボックス（複数選択可）」に変化する。
    * **Calculation Logic (計算仕様):**
        * 持続型スキルは、発動設定された**各フェーズにおいて個別に**「固有ダイスセクション」へダイス式（`1d10`）を出力する。
        * そのダイス結果は「そのフェーズの獲得スコア」として扱われ、単発固有スキルと同様に累積合計スコアへ加算される。
        * ※「一度の発動で以降のフェーズ全てに固定バフがかかる」のではなく、「指定されたフェーズごとに毎回ダイスを振って加算する」挙動とする。
    * **Validation (持続型の制約):**
        * 原則として「連続する2つのフェーズ（例: 中盤2・終盤）」を選択して発動する運用とする。
        * ツール側ではエラーにせず警告（Warning）レベル、あるいはGMの裁量による自由選択（3つ以上など）も許容する柔軟な実装とする。
* **[v] 特殊戦法・状態異常 (Status Effects):**
    * 次項の「Status Effect Logic」を有効化し、Scene 3 に専用のトグルUI（捲り/溜め等）を表示する。

#### 3. 状態異常ロジック (Status Effect Logic / Future Queue)
「現在の行動が将来のターンに影響する」戦法を自動計算するシステム。

* **Parameters & Constraints (定義と制約):**
    * **Effect Value (N):**
        * デフォルト値: ``15``
        * 設定変更: ハウスルール設定画面にて変更可能。
    * **Application Timing (適用タイミング):**
        * **事後適用 (Manual Trigger):** ダイス結果確定後、GMがツールの操作パネルで適用操作（ON）を行った時点でスコアに反映する。
    * **Cancellation (取り消し処理):**
        * 適用操作を取り消した場合、即座に「現在フェーズへの補正」および「将来フェーズへの予約効果（Queue）」の双方を消去し、完全に適用前の状態へ復元する。
    * **Usage Limit:**
        * 1レースにつき1回のみ「確定」可能。
        * フェーズ遷移によって確定されるまでは、何度でもON/OFF（適用/取り消し）を変更可能とする。
    * **Phase Restriction (フェーズ制限):**
        * **終盤フェーズ**においては、特殊戦法の選択UIを**非表示（選択不可）**とする。
            * **理由(溜め):** 効果を発揮すべき「将来のフェーズ」が存在しないため。
            * **理由(捲り):** 「現在の加点」と「予約される反動（減算）」が同一フェーズ内で衝突するため。

* **捲り (Makuri):**
    * *Action:* 選択したフェーズ（現在）のスコアに ``+N`` する。
    * *Effect (Queue):* 自動的に「終盤」フェーズに対して ``-N`` の補正予約（Queue）を入れる。
        * ※上記の制限により、終盤フェーズでの発動は不可となる。
    * *Resolve:* 終盤フェーズ到達時、予約されたマイナス補正を自動適用し、内訳に `(捲り反動)` と表示する。

* **溜め (Tame):**
    * *Action:* 選択したフェーズ（現在）のスコアに ``-N`` する。
    * *Effect (Queue):* 自動的に「終盤」フェーズに対して ``+N`` の補正予約を入れる。
        * ※上記の制限により、終盤フェーズでの発動は不可となる。

#### 4. データ永続化 (Persistence & Configuration Management)
* **Auto Save:**
    * `LocalStorage` を使用し、入力中の参加者リスト、レース進行状態、ハウスルール設定を常時保存する。
    * ブラウザリロード時に状態を完全復元する。
* **Config Management (JSON):**
    * ハウスルール設定（カスタム脚質データ、オプションON/OFF状態）を JSON形式 で エクスポート/インポート する機能を提供する。
    * *Validation:* インポート時、JSONスキーマ検証（`zod`等を使用）を行い、不正な構造を持つファイルの読み込みをブロックする。

### C. Architecture & Extensibility
システムの持続可能性と出力品質を担保するための非機能・アーキテクチャ要件。

#### 1. Parser Plugin System (拡張可能な解析機構)
掲示板ごとのフォーマット差異や将来の仕様変更を吸収するため、解析ロジックを疎結合にする。

* **Architecture:**
    * `ParserInterface` を定義し、具体的な解析処理はプラグイン（Parser Implementation）として実装する。
    * **Interface:** `parse(text: string, context: 'RACE' | 'PACE'): ParseResult`

* **Auto-detection Strategy (自動判別ロジック):**
    * GMによる手動選択は行わず、入力テキストの特徴に基づいて適切なパーサーを自動適用する。
    * **Rule:** 入力テキストに絵文字「🎲」が含まれる場合、`88-ch (EmojiParser)` と判定する。それ以外はデフォルトとして `Standard (StandardParser)` を適用する。

* **A. StandardParser (Default / Animan):**
    * 本ツールにおけるデフォルトの解析器。あにまん掲示板（および互換性のある掲示板）の仕様に準拠する。

    * **出力フォーマット (Output Strategy):**
        * ツールからダイスを出力する際、名前とダイス式の間に **「全角スペース (U+3000)」** を区切り文字として挿入する。
        * *Format:* `[名前]　dice[XdY]=`

    * **前処理 (Pre-processing):**
        * `<p>` タグなどのHTMLタグを除去する。
        * 空行、および空白のみの行を削除（フィルタリング）する。

    * **解析ロジック (Context-Aware Logic):**
        * 渡された `context` に応じてロジックを切り替える。

        * **Context 1: RACE (通常フェーズ: 序盤・中盤・終盤)**
            * **Step 1: アンカー探索:**
                * 行末（右側）から `dice(\d+)d(\d+)=` を検索し、ダイス式を特定する。
            * **Step 2: 名前抽出:**
                * アンカーより左側の文字列を名前として抽出する。
                * 名前に含まれるスペースや "dice" という文字列に惑わされないよう、行末アンカーそのものを基準とする。
            * **Step 3: 数値抽出と厳格な検証 (Validation):**
                * 正規表現 `dice\d+d\d+=(.*?)(?:\s*\((\d+)\))?$` を使用。
                * **検算 (Verify):** 内訳部分の合計と `(合計)` の値が一致するか必ず確認する。
                * **欠落チェック:** `(合計)` が欠落している、または検算が合わない場合はエラーとして扱う（GMによる手書き改竄防止のため）。

        * **Context 2: PACE (ペースフェーズ)**
            * **Step 1: 全文検索:**
                * 行の構造や名前を無視し、テキスト全体から `dice1d9=` を含む行を検索する。
            * **Step 2: 値の特定:**
                * `dice1d9=N` の N を抽出し、ペースを決定する。

* **B. EmojiParser (88-ch / Emoji Support):**
    * **特徴:** 絵文字「🎲」を含むフォーマットに対応する。
    * **Pre-processing:** `🎲` を検出し、標準的な区切り文字（半角スペース等）に置換（または除去）することで、以降の処理を標準ロジック（StandardParser相当）に委譲、あるいは独自の正規表現で解析する。
    * **正規化:** `名前 🎲 dice...` -> `名前  dice...`

* **Extensibility:**
    * 将来的に他サイト（あるいは仕様変更後）のパーサーを追加する際、コアロジック（計算機）に影響を与えずに「パーサーの差し替え」または「追加選択」のみで対応可能な構造とする。

#### 2. Image Generation Strategy (画像生成戦略)
最終結果を掲示板投稿用に画像化する機能。

* **Technology:** `html2canvas` を使用する。
    * **Off-screen Rendering (画面外レンダリング):**
        * **技術制約:** `html2canvas` は `display: none` や `visibility: hidden` が適用されている要素を描画できない仕様がある。
        * **実装手法:** したがって、画像生成用コンテナは **「ブラウザのビューポート外（画面外）に絶対配置する」** 手法を採用する。
            * *CSS Example:* `position: fixed; top: 0; left: -9999px; width: 1200px;`
        * これにより、ユーザーの画面（スマホ等）には表示させず、かつDOM上ではレンダリング可能な状態を維持する。
    * **Pagination (分割生成):**
        * **制限:** `html2canvas` のCanvasサイズ制限（特にモバイル端末）を回避し、可読性を維持するため、1画像あたりの最大行数を **25行** に制限する。
        * **実装:** データが26件以上ある場合、事前にデータを25件ごとのチャンクに分割し、それぞれのチャンクに対して個別にレンダリング→画像生成のプロセスを実行するループ処理を実装する。
* **Design & Extensibility (デザインと拡張性):**
    * **Phase 1 (MVP):** 開発速度を優先し、Tailwind CSSを用いたシンプルな標準テーブルスタイルで実装する。
    * **Future Proofing:** 将来的に「電光掲示板風」等のテーマ切り替えを容易にするため、画像生成コンポーネント（`src/components/hidden/ResultImage.tsx` 等）は、データ構造とデザイン定義（CSS/ClassName）を分離した設計とする。
* **Content Control (情報制御):**
    * 画像生成用テンプレートにおいては、**「判定(Judgment)」列などのGM管理用情報は自動的に除外（非表示化）** し、純粋な順位と着差のみを出力するデザインとする。

## 4. Technical Stack & Directory Structure
本プロジェクトは、GitHub Pagesでのホスティングを前提とした完全なクライアントサイドSPAとして構築する。
複雑な計算ロジックとUIを切り離し、将来的な拡張（プラグイン追加やルール変更）に耐えうるアーキテクチャを採用する。

### A. Technical Stack
* **Runtime Environment:**
    * **Single Page Application (SPA):** サーバーサイド処理を一切持たない。
    * **Hosting:** GitHub Pages
* **Core Framework:**
    * **React 18+:** UI構築およびコンポーネント管理。
    * **Vite:** ビルドツール。高速なHMRと軽量なバンドル生成のため採用。
* **Language:**
    * **TypeScript (Strict Mode):** 必須。複雑な計算ロジックやデータ構造（ハウスルール、フェーズ状態）の整合性を型レベルで担保する。
* **Styling:**
    * **Tailwind CSS:** ユーティリティファーストCSS。レスポンシブ対応（PC/スマホ）を迅速に行うため採用。
* **State Management:**
    * **React Context API + useReducer:** レース進行状態（Undo/Redo履歴、未来の補正予約）やハウスルール設定をグローバルに管理する。
* **Key Libraries:**
    * **html2canvas:** リザルト画像の生成（Off-screen rendering）。
    * **zod:** 外部入力データ（インポートするJSON設定ファイル）のスキーマバリデーション。不正なファイルの読み込みをランタイムで阻止する。
    * **lucide-react:** UIアイコン。
    * **clsx / tailwind-merge:** 動的なクラス名制御（エラー時のスタイル切り替え等）。
    * **Performance Optimization:**
        * **Virtual Scrolling:** 100人規模のエントリーに対応するため、`react-window` や `react-virtuoso` 等の仮想スクロールライブラリを導入し、レンダリングコストを最小化する。

### B. Directory Structure
「ドメインロジック（計算・ルール）」と「UIコンポーネント（表示・操作）」を明確に分離するディレクトリ構成とする。

```text
root/
├── .github/
│   └── workflows/      # GitHub Actions (Deploy to GitHub Pages)
├── docs/               # 要件定義書、設計資料 (Read Only)
│   ├── REQUIREMENTS.md
│   └── ARCHITECT_HANDOVER.md
├── gas_src/            # Google Apps Script (Reserved for future sheet integration)
│   └── (README.md)     # ※現フェーズでは使用しないが、拡張用に場所を確保する
├── public/             # Static Assets (Favicon, Manifest)
├── src/
│   ├── assets/         # Global Styles (Tailwind directives)
│   ├── components/     # React Components
│   │   ├── ui/         # Generic UI Atoms (Button, Input, Card, Modal, Toast)
│   │   ├── shared/     # Shared Organisms (Header, Footer, ErrorBoundary)
│   │   ├── hidden/     # Off-screen Components (画像生成用の隠しレンダリング領域)
│   │   └── scenes/     # Scene-specific Page Components (各画面のメインUI)
│   │       ├── Setup/          # Scene 1: Entry & Config
│   │       ├── GateLottery/    # Scene 2: Gate Logic
│   │       ├── Progression/    # Scene 3: Main Race Loop
│   │       └── FinalResult/    # Scene 4: Judgment & Result
│   ├── core/           # Domain Logic (PURE TYPESCRIPT - NO UI/REACT DEPENDENCIES)
│   │   ├── types.ts    # Domain Types (RaceState, Entry, HouseRule, FutureEffect)
│   │   ├── constants.ts # Default Rules (Dice Tables, Pace Mods)
│   │   ├── calculator/ # Calculation Logic
│   │   │   ├── index.ts      # Main Calculator
│   │   │   ├── strategies.ts # 脚質ロジック
│   │   │   └── effects.ts    # 状態異常・予約効果(Queue)の処理
│   │   └── parser/     # Text Parsing Logic
│   │       ├── interface.ts  # ParserInterface definition
│   │       └── implementations/
│   │           └── StandardParser.ts # Default parser logic
│   ├── hooks/          # Custom React Hooks
│   │   ├── useRaceEngine.ts  # State Machine (Undo/Redo, Phase transition)
│   │   └── usePersistence.ts # LocalStorage & JSON Handler
│   ├── utils/          # Helper Functions (Formatters, Validators)
│   ├── App.tsx         # Main Routing / Layout
│   └── main.tsx        # Entry Point
├── package.json
├── tailwind.config.js
├── tsconfig.json
└── vite.config.ts
```

### C. Implementation Guidelines
1.  **Separation of Concerns (関心の分離):**
    * `src/core/` 以下のコードは、ReactやDOMに一切依存してはならない。ここには純粋なTypeScriptのクラス/関数のみを配置する。これにより、ロジックの単体テストを容易にし、将来的なプラットフォーム変更（例：Node.jsサーバー化）にも対応可能とする。
2.  **Scene Management & State:**
    * `App.tsx` または `Layout` コンポーネントが `CurrentPhase` ステートを監視し、`src/components/scenes/` 内の適切なコンポーネントを切り替えて表示する。
    * データは `useRaceEngine` フック内で一元管理し、画面遷移時にデータが失われないようにする。
3.  **Strict Validation:**
    * 外部からの入力（掲示板テキストの解析結果、JSONファイルのインポート）に対しては、必ず `zod` 等を用いたバリデーションを通し、型安全性を確保してから `State` に反映させる。`any` 型の使用は禁止とする。
4.  **Image Generation Constraint:**
    * リザルト画像の生成時、`useRef` 等で参照するコンテナ要素は必ず「可視状態（`display: block` 等）」である必要がある。
    * ユーザーから隠す場合は、CSSの `position` プロパティを使用して画面領域外へ飛ばすこと。決して `display: none` を使用してはならない。